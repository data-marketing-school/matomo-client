___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "CLIENT",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Matomo",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Matomo Analytics client template.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "matomoPath",
    "displayName": "Request Path",
    "simpleValueType": true,
    "valueHint": "1fkn32jn4",
    "defaultValue": "matomo.php"
  },
  {
    "type": "CHECKBOX",
    "name": "loadJavascriptLibrary",
    "checkboxText": "Load Javascript library",
    "simpleValueType": true,
    "subParams": [
      {
        "type": "TEXT",
        "name": "customPath",
        "displayName": "Javascript Library Path",
        "simpleValueType": true,
        "defaultValue": "matomo.js",
        "enablingConditions": [
          {
            "paramName": "loadJavascriptLibrary",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "allowedOrigins",
    "displayName": "Allowed Origins",
    "simpleValueType": true,
    "defaultValue": "*",
    "help": "Enter a comma-separated list of origins (e.g. \u003cstrong\u003ehttps://data-marketing-school.com\u003c/strong\u003e,\u003cstrong\u003ehttps://www.data-marketing-school.com\u003c/strong\u003e or use the asterisk (*) as a wildcard. If the request comes from some other origin, the request will not be claimed. To pass an origin manually, add the \u0026origin\u003d parameter to the request URL.",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^(\\s*(\\*|https?:\\/\\/\\/?[-a-zA-Z0-9@:%._\\+~#\u003d]{1,256}\\.[a-zA-Z0-9()]{1,6}(?:[-a-zA-Z0-9()@:%_\\+.~#?\u0026\\/\u003d]*)?)\\s*)(,\\s*(\\*|https?:\\/\\/\\/?[-a-zA-Z0-9@:%._\\+~#\u003d]{1,256}\\.[a-zA-Z0-9()]{1,6}(?:[-a-zA-Z0-9()@:%_\\+.~#?\u0026\\/\u003d]*)?)\\s*)*$"
        ],
        "errorMessage": "This field should contain either \u003cb\u003e*\u003c/b\u003e or URL starting with \u003cb\u003ehttps://\u003c/b\u003e."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const claimRequest = require('claimRequest');  
const getRequestPath = require('getRequestPath');
const path = getRequestPath();
const log = require('logToConsole');
const runContainer = require('runContainer');
const returnResponse = require('returnResponse');
const parseUrl = require('parseUrl');
const getRequestQueryParameters = require('getRequestQueryParameters');
const queryParams = getRequestQueryParameters();
const getRemoteAddress = require('getRemoteAddress');
const getRequestHeader = require('getRequestHeader');
const ua = getRequestHeader('user-agent');
const getTimestampMillis = require('getTimestampMillis');
const templateDataStorage = require('templateDataStorage');
const sendHttpGet = require('sendHttpGet');
const setResponseBody = require('setResponseBody');
const setResponseHeader = require('setResponseHeader');
const setResponseStatus = require('setResponseStatus');

const cacheMaxTimeInMs = 450000;
const httpEndpoint = 'https://cdn.matomo.cloud/matomo.js';

const storedJs = 'matomo_js';
const storedHeaders = storedJs + '_headers';
const storedTimeout = storedJs + '_timeout';

const origin = getRequestHeader('origin') || (!!getRequestHeader('referer') && parseUrl(getRequestHeader('referer')).origin) || queryParams.origin;

const eventModel = generateEventModel(queryParams);

if(path === '/'+data.matomoPath && validateOrigin()) {
  claimRequest();
  runContainer(eventModel, () => returnResponse());
} else if(data.loadJavascriptLibrary && path === '/'+data.customPath && validateOrigin()) {
  claimRequest();
  fetchMatomoJsLibrary();
}

function generateEventModel(queryParams) {
  queryParams.cip = getRemoteAddress();
  queryParams.ua = ua;
  queryParams.event_name = 'page_view';
  
  if(queryParams.ping) queryParams.event_name = 'heartbeat';
  if(queryParams.e_n) queryParams.event_name = 'event';
  if(queryParams.idgoal && queryParams.idgoal > 0) queryParams.event_name = 'goal';
  if(queryParams.idgoal && queryParams.idgoal == 0 && queryParams.ec_id) {
    queryParams.event_name = 'ecommerce_order';
  }
  if(queryParams.idgoal && queryParams.idgoal == 0 && !queryParams.ec_id) {
    queryParams.event_name = 'cart_update';
  } 
  if(queryParams.c_n && !queryParams.c_i) queryParams.event_name = 'content_impression';
  if(queryParams.c_i) queryParams.event_name = 'content_interaction';
  if(queryParams.search) queryParams.event_name = 'search';
  if(queryParams.link) queryParams.event_name = 'link';
  if(queryParams.download) queryParams.event_name = 'download';
  
  return queryParams;
}

function validateOrigin() {
  return data.allowedOrigins === '*' || data.allowedOrigins.split(',').indexOf(origin) > -1;
}

function fetchMatomoJsLibrary() {
  const now = getTimestampMillis();
  const storageTimeout = now - cacheMaxTimeInMs;
  if (!templateDataStorage.getItemCopy(storedJs) || 
      templateDataStorage.getItemCopy(storedTimeout) < storageTimeout) {
    sendHttpGet(httpEndpoint, (statusCode, headers, body) => {
      if (statusCode === 200) {
        templateDataStorage.setItemCopy(storedJs, body);
        templateDataStorage.setItemCopy(storedHeaders, headers);
        templateDataStorage.setItemCopy(storedTimeout, now);
      }
      sendResponse(body, headers, statusCode);
    }, {timeout: 1500});
  } else {
    sendResponse(
      templateDataStorage.getItemCopy(storedJs),
      templateDataStorage.getItemCopy(storedHeaders),
      200
    );
  }
}

function sendResponse(response, headers, statusCode) {
  setResponseStatus(statusCode);
  setResponseBody(response);
  for (const key in headers) {
    if (['expires', 'date'].indexOf(key) === -1) setResponseHeader(key, headers[key]);
  }
  if (data.encodingHeader) {
    setResponseHeader('Content-Encoding', 'gzip');
  }
  returnResponse();
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "run_container",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "return_response",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_template_storage",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.matomo.cloud/matomo.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 20/05/2024, 16:32:24


